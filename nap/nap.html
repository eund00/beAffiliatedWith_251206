<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>낮잠</title>
    <link rel="stylesheet" href="nap.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"
    />
  </head>

  <body>
    <div class="stage">
      <div class="canvas" id="canvas">
        <div class="word-map" id="wordMap"></div>
      </div>

      <div id="fog" class="fog-layer"></div>

      <div class="menu-box">
        <div class="stanza" id="stanzaCard" role="button" tabindex="0">
          <div class="in_text">
            <h2 id="stanzaTitle">시의 숨</h2>
            <p id="stanzaText">여기를 클릭하면 다음 연이 열린다.</p>
          </div>
          <div class="btn_wrap">
            <button id="prevBtn" type="button">이전 연</button>
            <button id="nextBtn" type="button" class="btn-accent">
              다음 연
            </button>
            <button id="randomizeBtn" type="button">단어 재배치</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* -----------------------------
          데이터
      ------------------------------*/
      const POEM = {
        title: "낮잠",
        stanzas: [
          "울렁거리는 커튼 사이로",
          "촘촘하게 햇빛이 들어오는 날",
          "화창하고 어둡고",
          "따뜻하고 지겹고",
          "두근거리고 어지러워",
          "꿈. 꾸움. 꾸-움.",
          "날. 나알. 나-알.",
          "모든 건 늘이면 푹신해지더라고",
          "결국 공허인 걸 알아차려서",
          "꿈 밖에서도 꿈을 꾸나봐",
          "대낮에 뱉어내는 잠꼬대는",
          "분명 누군가에게 닿을 것 같아서",
          "잠을 자면서도 말을 걸었더니",
          "꿈속에서 천사가 나타났어",
          "너는 자라면서 뼈를 잃게 될 거양",
          "유리관에 든 몸 안엔 별사탕이 가득할 거양",
          "누워서 잠을 자면 발밑에 있던 감정이",
          "수평을 잃고 네 얼굴을 덮칠 거양",
          "잠을 자는 건 무서운 일이 될 고양",
          "아. 뭐래.",
          "한낮이 지나간 자리에는",
          "창문으로 들어온 어둠이 방을 채우고 있어",
          "베게에 눈물을 한가득 쏟아내면",
          "공허한 삶이 조금은 개운해질까 봐",
          "뒤척이며 몸을 돌려 누웠는데",
          "너의 얼굴을 한 천사가 코를 고는 거야",
          "훙냐. 후냐아. 훙-냐아.",
          "나 정말 킹받아.",
        ],
      };

      /* -----------------------------
          요소 선택
      ------------------------------*/
      const wordMap = document.getElementById("wordMap");
      const stanzaCard = document.getElementById("stanzaCard");
      const stanzaTitle = document.getElementById("stanzaTitle");
      const stanzaText = document.getElementById("stanzaText");
      const fog = document.getElementById("fog");
      const nextBtn = document.getElementById("nextBtn");
      const prevBtn = document.getElementById("prevBtn");
      const randomizeBtn = document.getElementById("randomizeBtn");

      /* -----------------------------
          상태
      ------------------------------*/
      let stanzaIndex = 0;
      let words = [];
      let mouse = { x: 0.5, y: 0.5 };

      /* -----------------------------
          유틸 함수
      ------------------------------*/
      const tokenize = (t) =>
        t.replace(/\n/g, " \n ").split(/\s+/).filter(Boolean);

      /* -----------------------------
          단어 맵 구성
      ------------------------------*/
      function buildWordMap(poem) {
        wordMap.innerHTML = "";
        words = [];

        const tokens = tokenize(poem.stanzas.join(" "));
        const rect = wordMap.getBoundingClientRect();
        const W = rect.width || window.innerWidth;
        const H = rect.height || window.innerHeight;

        tokens.forEach((tok, i) => {
          const el = document.createElement("div");
          el.className = "word";
          el.textContent = tok === "\n" ? "" : tok;

          const fontSize = 14 + Math.random() * 18;
          el.style.fontSize = fontSize + "px";

          const left = Math.random() * W * 0.9;
          const top = Math.random() * H * 0.9;

          el.style.left = left + "px";
          el.style.top = top + "px";

          const rot = (Math.random() - 0.5) * 12;

          words.push({ el, left, top, rot });

          el.style.transform = `rotate(${rot}deg)`;
          wordMap.appendChild(el);
        });
      }

      /* -----------------------------
          단어 재배열
      ------------------------------*/
      function randomizeWords() {
        const rect = wordMap.getBoundingClientRect();
        const W = rect.width;
        const H = rect.height;

        words.forEach((w) => {
          w.left = Math.random() * W * 0.9;
          w.top = Math.random() * H * 0.9;

          w.el.style.left = w.left + "px";
          w.el.style.top = w.top + "px";
        });
      }

      /* -----------------------------
          연 표시 + 해당 단어 강조
      ------------------------------*/
      function showStanza(i) {
        stanzaIndex = Math.max(0, Math.min(i, POEM.stanzas.length - 1));

        // 제목과 텍스트 업데이트
        stanzaTitle.textContent = `${POEM.title} — (${stanzaIndex + 1}/${
          POEM.stanzas.length
        })`;
        stanzaText.textContent = POEM.stanzas[stanzaIndex];

        // 현재 시 구절 단어 단위로 쪼개기 (띄어쓰기 기준)
        const currentWords = new Set(
          POEM.stanzas[stanzaIndex].split(/\s+/).filter(Boolean)
        );

        // wordMap 안 단어들 반복
        words.forEach((w) => {
          const wordText = w.el.textContent.trim();

          // 일치 여부 확인
          if (currentWords.has(wordText)) {
            w.el.classList.add("here_point"); // 여기 강조
            w.el.style.opacity = 1;
            w.el.style.zIndex = 2;
          } else {
            w.el.classList.remove("here_point");
            w.el.style.opacity = 0.3;
            w.el.style.zIndex = 1;
          }
        });
      }

      /* -----------------------------
          패럴랙스 + 흐림 효과
      ------------------------------*/
      document.getElementById("canvas").addEventListener("mousemove", (e) => {
        const r = e.currentTarget.getBoundingClientRect();
        mouse.x = (e.clientX - r.left) / r.width;
        mouse.y = (e.clientY - r.top) / r.height;
      });

      function animate() {
        const px = (mouse.x - 0.5) * 2;
        const py = (mouse.y - 0.5) * 2;

        words.forEach((w, idx) => {
          const depth = 0.01 + (idx % 6) * 0.008;
          const tx = px * 2000 * depth;
          const ty = py * 1400 * depth;

          w.el.style.transform = `translate(${tx}px, ${ty}px) rotate(${w.rot}deg)`;
        });

        const scrollRatio =
          window.scrollY / (document.body.scrollHeight - window.innerHeight);

        fog.style.opacity = 0.7 - Math.min(scrollRatio * 0.7, 0.65);

        requestAnimationFrame(animate);
      }

      /* -----------------------------
          좌우 버튼 재배열 이벤트
      ------------------------------*/
      stanzaCard.addEventListener("click", () => showStanza(stanzaIndex + 1));

      nextBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        showStanza(stanzaIndex + 1);
      });

      prevBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        showStanza(stanzaIndex - 1);
      });

      randomizeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        randomizeWords();
      });

      /* -----------------------------
          초기화
      ------------------------------*/
      buildWordMap(POEM);
      showStanza(0);
      animate();

      window.addEventListener("resize", randomizeWords);
    </script>
  </body>
</html>
